Build Image
===========
# from http://prefetch.net/articles/yumchrootlinux.html

sudo yum install gcc-c++ gcc pcre-devel zlib-devel make expat-devel httpd-devel autoconf automake boost-devel openssl-devel python26-devel byacc flex

sudo mkdir -p /srv/chroot/template/var/lib/rpm
sudo rpm --root /srv/chroot/template --initdb
sudo mkdir /srv/chroot/template/dev/

sudo yum --installroot=/srv/chroot/template install -y basesystem
cd /srv/chroot/template
sudo rm -rf boot/ home/ media/ mnt/ opt/ proc/ root/ sys/ tmp/ selinux/

yumdownloader --destdir=/var/tmp glibc bash ncurses-base ncurses-libs pcre expat nss-softokn-freebl zlib libgcc python26 python26-libs libxml2-devel php php-cli libedit gmp bzip2-libs libxml2 krb5-libs libcom_err openssl keyutils-libs libselinux php-mysql mysql55-libs libstdc++ php-pdo php-curl php-pecl-memcached php-pecl-memcache php-pear libmemcached php-common libcurl libidn openldap info nss nss-util nspr libssh2 cyrus-sasl-lib php-mbstring php-pecl-imagick ImageMagick lcms-libs libtiff freetype libjpeg fontconfig libXext libXt libgomp libtool-ltdl libSM libICE libX11 libuuid libxcb libXau php-fpm coreutils grep tzdata sed gawk
sudo rpm --root /srv/chroot/template/ -ivh --nodeps /var/tmp/*.x86_64.rpm
sudo rm /srv/chroot/template/etc/php.d/pdo_sqlite.ini /srv/chroot/template/etc/php.d/sqlite3.ini
cd /srv/chroot/template/usr/bin
sudo ln -s python26 python

cd /var/tmp
wget ftp://ftp.tc.edu.tw/pub/Apache//httpd/httpd-2.2.22.tar.gz
tar zxvf httpd-2.2.22.tar.gz
cd httpd-2.2.22

cd srclib
wget http://apache.cdpa.nsysu.edu.tw//apr/apr-1.4.6.tar.gz
tar zxvf apr-1.4.6.tar.gz
mv apr-1.4.6 apr
wget http://apache.cdpa.nsysu.edu.tw//apr/apr-util-1.4.1.tar.gz
tar zxvf apr-util-1.4.1.tar.gz
mv apr-util-1.4.1 apr-util
cd ..

./configure --enable-rewrite --enable-deflate --with-included-apr --with-mpm=worker
make DESTDIR=/srv/chroot/template
sudo make DESTDIR=/srv/chroot/template install

cd modules
wget http://www.fastcgi.com/dist/mod_fastcgi-2.4.6.tar.gz
tar zxvf mod_fastcgi-2.4.6.tar.gz
mv mod_fastcgi-2.4.6 fastcgi
cd fastcgi
cp Makefile.AP2 Makefile
make top_dir=../../
sudo cp .libs/mod_fastcgi.so /srv/chroot/template/usr/local/apache2/modules/mod_fastcgi.so
cd ../
wget 'https://github.com/ronnywang/mod_rpaf/tarball/master'
tar zxvf master
mv ronnywang-mod_rpaf-* mod_rpaf
cd mod_rpaf
make
sudo cp .libs/mod_rpaf.so /srv/chroot/template/usr/local/apache2/modules/mod_rpaf.so

# thrift...
cd /var/tmp/
wget https://dist.apache.org/repos/dist/release/thrift/0.9.0/thrift-0.9.0.tar.gz
tar zxvf thrift-0.9.0.tar.gz
cd thrift-0.9.0
./configure
sudo make DESTDIR=/srv/chroot/template install
sudo make install

# thrift/contrib/fb303
cd contrib/fb303
./bootstrap.sh
./configure CPPFLAGS="-DHAVE_INTTYPES_H -DHAVE_NETINET_IN_H"
sudo make DESTDIR=/srv/chroot/template install

# scribe
cd /var/tmp
rm -f master
wget 'https://github.com/facebook/scribe/tarball/master'
tar zxvf master
mv facebook-scribe-* scribe
cd scribe
./bootstrap.sh --with-boost-filesystem=boost_filesystem
./configure --with-boost-filesystem=boost_filesystem CPPFLAGS="-DHAVE_INTTYPES_H -DHAVE_NETINET_IN_H"
sudo make DESTDIR=/srv/chroot/template install
sudo make all install

sudo cp /etc/resolv.conf /srv/chroot/template/etc/
sudo cp /srv/code/hisoku/scripts/scribelogger /srv/chroot/template/usr/local/bin/
sudo rm /srv/chroot/template/etc/shadow /srv/chroot/template/etc/gshadow
sudo cp /srv/code/hisoku/config/template/php/php.ini /srv/chroot/template/etc/
sudo cp /srv/code/hisoku/config/template/php/php-fpm.conf /srv/chroot/template/etc
sudo cp /srv/code/hisoku/config/template/php/node.conf /srv/chroot/template/usr/local/apache2/conf/extra/
sudo cp --preserve=mode /srv/code/hisoku/config/template/php/*.sh /srv/chroot/template/
sudo sh -c 'echo -e "\nInclude conf/extra/node.conf" >> /srv/chroot/template/usr/local/apache2/conf/httpd.conf'
sudo sh -c 'echo -e "\nwww-user:x:10003:99::/srv/deploy:/sbin/nologin" >> /srv/chroot/template/etc/passwd'
sudo mkdir -p /srv/chroot/template/usr/local/apache2/logs/fastcgi/dynamic


New Node Server
===============
開 deploy 帳號(不需要能被登入)
------------------------------
sudo groupadd -g 10002 deploy
sudo useradd -u 10002 -r -g deploy -d /srv/deploy deploy 
sudo mkdir -p ~deploy/
sudo chown -R deploy:deploy /srv/deploy

在 root 帳號開洞
----------------
sudo vim ~root/.ssh/authorized_keys
* 放入 command="/srv/code/hisoku/scripts/root@nodes-ssh_serve",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty {key}
sudo ssh-keygen
sudo cat ~root/.ssh/id_rsa.pub
* 將產生的 key 放進 hisoku-repo/scripts/update-keys 的 $deploy_keys 裡面
sudo ssh git@git-p.hisoku.ronny.tw
* 上面是讓 node server 記住 git-p.hisoku.ronny.tw 的 sign

安裝 git
--------
sudo yum install git php php-mysql php-pecl-memcached
* git 抓原始檔用
* php 執行 script 用

安裝 s3cmd
----------
wget 'http://downloads.sourceforge.net/project/s3tools/s3cmd/1.1.0-beta3/s3cmd-1.1.0-beta3.zip?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Fs3tools%2Ffiles%2F&ts=1357620359&use_mirror=nchc'
unzip s3cmd-1.1.0-beta3.zip
./s3cmd-1.1.0-beta3/s3cmd --configure
* 輸入 access key / secret / proxy

抓下 images
-----------
./s3cmd-1.1.0-beta3/s3cmd get s3://hisoku/images/php53.tgz
sudo mkdir /srv/chroot
sudo chown -R deploy:deploy /srv/chroot
sudo cp php53.tgz /srv/chroot
cd /srv/chroot
sudo tar zxvf php53.tgz

解開 template
-------------
sudo chown -R deploy:nobody /srv/chroot/template

開新的 node
===========
ssh root@{ip} init {id}
* id 可以是任意數字
