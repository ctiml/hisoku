#!/usr/bin/env php
<?php

include(__DIR__ . '/../webdata/init.inc.php');

function error($message)
{
    error_log($message);
    die();
}

function main()
{
    if (!getenv('SSH_ORIGINAL_COMMAND')) {
        return error('There is no SSH_ORIGINAL_COMMAND env');
    }

    $command = getenv('SSH_ORIGINAL_COMMAND');
    list($method) = explode(' ', $command, 2);
    switch ($method) {
    case 'restart-php-fpm':
        list(, $id) = explode(' ', getenv('SSH_ORIGINAL_COMMAND'));
        if (!$id = intval($id)) {
            error('invalid id: ' . $id);
        }
	if (file_exists("/srv/chroot/{$id}/var/run/php-fpm.pid")) {
		exec('kill ' . intval(file_get_contents("/srv/chroot/{$id}/var/run/php-fpm.pid")));
	}
        if (!file_exists("/srv/chroot/{$id}/dev/null")) {
            exec("mknod /srv/chroot/{$id}/dev/null c 1 3");
            exec("mknod /srv/chroot/{$id}/dev/random c 1 8");
            exec("mknod /srv/chroot/{$id}/dev/urandom c 1 9");
            exec("chmod 666 /srv/chroot/{$id}/dev/*");
        }
        exec("mkdir -p /srv/chroot/{$id}/usr/local/apache2/logs/fastcgi/dynamic");
	copy("/srv/code/hisoku/config/php-fpm.conf", "/srv/chroot/{$id}/etc/php-fpm.conf");
        copy("/srv/code/hisoku/scripts/init.sh", "/srv/chroot/{$id}/init.sh");
        copy("/srv/code/hisoku/scripts/scribelogger", "/srv/chroot/{$id}/usr/local/bin/scribelogger");
	exec("chown www-user /srv/chroot/{$id}/usr/local/apache2/logs/");
	exec("chown www-user /srv/chroot/{$id}/var/run");
	exec("chroot --userspec=10003:99 /srv/chroot/{$id}/ /usr/sbin/php-fpm");
	exec("chroot --userspec=10003:99 /srv/chroot/{$id}/ /usr/local/apache2/bin/apachectl graceful");
        break;

    case 'shutdown':
        list(, $nodes_count) = explode(' ', $command, 2);
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, 'http://169.254.169.254/latest/meta-data/local-hostname');
        curl_setopt($curl, CURLOPT_HEADER, 0);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        if (!$hostname = curl_exec($curl)) {
            trigger_error(curl_error($curl));
        }
        curl_close($curl);

        if (!$hostname) {
            die("local-hostname is not found");
        }

        if ($ip = gethostbyname($hostname)) {
            die("local-hostname {$hostname} error");
        }

        for ($i = 1; $i <= $nodes_count; $i ++) {
            if ($node = WebNode::find(array(ip2long($ip), 20000 + $i))) {
                $node->delete();
            }

            if (file_exists("/srv/chroot/{$i}/var/run/php-fpm.pid")) {
                exec('kill ' . intval(file_get_contents("/srv/chroot/{$i}/var/run/php-fpm.pid")));
            }
            if (file_exists("/srv/chroot/{$i}/usr/local/apache2/logs/httpd.pid")) {
                exec('kill ' . intval(file_get_contents("/srv/chroot/{$i}/usr/local/apache2/logs/httpd.pid")));
            }
            exec("rm -rf /srv/chroot/{$i}");
        }
        break;

    }
    return;
}

main();
